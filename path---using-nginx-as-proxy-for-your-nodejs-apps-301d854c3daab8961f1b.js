webpackJsonp([0x8d795c94240c],{653:function(n,s){n.exports={data:{post:{id:"E:/gatsby-starter-personal-blog/content/posts/2017-10-01--using-nginx-as-proxy-for-your-nodejs-apps/index.md absPath of file >>> MarkdownRemark",html:'<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/photo-34607920835_e26fff721f_o-d2808f473b3373fd2b78ca38e15ab5f5-fae0f.jpg"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 51.31313131313131%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAABAABBf/EABUBAQEAAAAAAAAAAAAAAAAAAAEC/9oADAMBAAIQAxAAAAHlIEoC21z/AP/EABoQAAICAwAAAAAAAAAAAAAAAAECAAMQETH/2gAIAQEAAQUCRVMaoAHcXuP/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAgEBPwFn/8QAFhAAAwAAAAAAAAAAAAAAAAAAACAh/9oACAEBAAY/AiL/AP/EABwQAQACAQUAAAAAAAAAAAAAAAEAERAhMUFRYf/aAAgBAQABPyFmll5sp7NTmbcV7x//2gAMAwEAAgADAAAAEHwf/8QAFhEBAQEAAAAAAAAAAAAAAAAAAQAR/9oACAEDAQE/EAEtv//EABcRAQADAAAAAAAAAAAAAAAAAAEQETH/2gAIAQIBAT8QsOx//8QAHBABAAIBBQAAAAAAAAAAAAAAAQARMSFBUXGB/9oACAEBAAE/ECCi3EbBskWNv0xpUp1HDadOZkn/2Q==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;"\n        alt="Hongkong"\n        title=""\n        src="/static/photo-34607920835_e26fff721f_o-d2808f473b3373fd2b78ca38e15ab5f5-78f2b.jpg"\n        srcset="/static/photo-34607920835_e26fff721f_o-d2808f473b3373fd2b78ca38e15ab5f5-dce19.jpg 200w,\n/static/photo-34607920835_e26fff721f_o-d2808f473b3373fd2b78ca38e15ab5f5-c1413.jpg 400w,\n/static/photo-34607920835_e26fff721f_o-d2808f473b3373fd2b78ca38e15ab5f5-78f2b.jpg 800w,\n/static/photo-34607920835_e26fff721f_o-d2808f473b3373fd2b78ca38e15ab5f5-ab4c4.jpg 1200w,\n/static/photo-34607920835_e26fff721f_o-d2808f473b3373fd2b78ca38e15ab5f5-bc99b.jpg 1600w,\n/static/photo-34607920835_e26fff721f_o-d2808f473b3373fd2b78ca38e15ab5f5-fae0f.jpg 1980w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<!-- TOC -->\n<ul>\n<li><a href="#01-useful-links">01 Useful links</a></li>\n<li><a href="#02-install-nginx-and-adjust-the-firewall">02 Install Nginx and Adjust the Firewall</a></li>\n<li><a href="#03-firewalld">03 FirewallD</a></li>\n<li><a href="#04-create-a-login">04 Create a login</a></li>\n<li><a href="#05-nginxconf">05 nginx.conf</a></li>\n<li><a href="#06-virtualconf">06 virtual.conf</a></li>\n<li>\n<p><a href="#07-godaddy-certs">07 GoDaddy Certs</a></p>\n<ul>\n<li><a href="#generate-a-csr-and-private-key">Generate a CSR and Private Key</a></li>\n<li><a href="#download-your-key-from-godaddy">Download your key from GoDaddy</a></li>\n<li><a href="#install-certificate-on-web-server">Install Certificate On Web Server</a></li>\n</ul>\n</li>\n<li>\n<p><a href="#08-letsencrypt-and-certbot">08 LetsEncrypt and Certbot</a></p>\n<ul>\n<li><a href="#install-certbot-on-centos-7">Install Certbot on CentOS 7</a></li>\n<li><a href="#run-certbot">Run Certbot</a></li>\n<li><a href="#setting-up-auto-renewal">Setting Up Auto Renewal</a></li>\n<li><a href="#systemd">Systemd</a></li>\n<li><a href="#crond">Cron.d</a></li>\n<li><a href="#tls-sni-01-challenge-deactivated">TLS-SNI-01 challenge Deactivated</a></li>\n</ul>\n</li>\n</ul>\n<!-- /TOC -->\n<h2 id="01-useful-links"><a href="#01-useful-links" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>01 Useful links</h2>\n<hr>\n<ul>\n<li><a href="https://kyup.com/tutorials/set-http-authentication-nginx/">Apache2-Utils</a></li>\n<li><a href="https://www.ssllabs.com/ssltest/">SSL Labs</a></li>\n<li><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-nginx-with-http-2-support-on-ubuntu-16-04">Set up NGINX with http/2</a></li>\n<li><a href="https://www.digitalocean.com/community/tutorials/how-to-create-a-self-signed-ssl-certificate-for-nginx-on-centos-7/">Create a self-signed Certificate</a></li>\n<li><a href="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-centos-7">How To Secure Nginx with Let’s Encrypt on CentOS 7</a></li>\n<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/install-elasticsearch.html">Installing Elasticsearch</a></li>\n<li><a href="https://www.elastic.co/guide/en/kibana/current/install.html">Installing Kibana</a></li>\n<li><a href="https://www.elastic.co/downloads/x-pack">Installing X-Pack</a></li>\n</ul>\n<h2 id="02-install-nginx-and-adjust-the-firewall"><a href="#02-install-nginx-and-adjust-the-firewall" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>02 Install Nginx and Adjust the Firewall</h2>\n<hr>\n<ul>\n<li><strong>Step One</strong> — Nginx is not available in CentOS’s default repositories - but we can install it from the EPEL (extra packages for Enterprise Linux) repository.</li>\n</ul>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text"> sudo yum install epel-release</code></pre>\n      </div>\n<ul>\n<li><strong>Step Two</strong> — Next, we can install Nginx.</li>\n</ul>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text"> sudo yum install nginx</code></pre>\n      </div>\n<ul>\n<li><strong>Step Three</strong> — Start the Nginx service and test it inside your browser <a href="http://server_domain_name_or_IP/">http://server<em>domain</em>name<em>or</em>IP/</a></li>\n</ul>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text"> sudo systemctl start nginx</code></pre>\n      </div>\n<ul>\n<li><strong>Step Four</strong> — Check that the service is up and running by typing:</li>\n</ul>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text"> systemctl status nginx</code></pre>\n      </div>\n<ul>\n<li><strong>Step Five</strong> — You will also want to enable Nginx, so it starts when your server boots:</li>\n</ul>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text"> sudo systemctl enable nginx</code></pre>\n      </div>\n<h2 id="03-firewalld"><a href="#03-firewalld" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>03 FirewallD</h2>\n<hr>\n<ul>\n<li><strong>Step One</strong> — Installation</li>\n</ul>\n<p>Open ports 80 and 443 in <a href="http://www.firewalld.org/">FirewallD</a></p>\n<p>To start the service and enable FirewallD on boot:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">sudo systemctl start firewalld\nsudo systemctl enable firewalld</code></pre>\n      </div>\n<p>To stop and disable it:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">sudo systemctl stop firewalld\nsudo systemctl disable firewalld</code></pre>\n      </div>\n<p>Check the firewall status. The output should say either running or not running:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">sudo firewall-cmd --state</code></pre>\n      </div>\n<p>To view the status of the FirewallD daemon:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">sudo systemctl status firewalld</code></pre>\n      </div>\n<p>To reload a FirewallD configuration:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">sudo firewall-cmd --reload</code></pre>\n      </div>\n<ul>\n<li><strong>Step Two</strong> — Configuration</li>\n</ul>\n<p>Add the http/s rule to the permanent set and reload FirewallD.</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">sudo firewall-cmd --zone=public --add-service=https --permanent\nsudo firewall-cmd --zone=public --add-service=http --permanent\nsudo firewall-cmd --reload</code></pre>\n      </div>\n<p>Allow traffic / block traffic over ports:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">sudo firewall-cmd --zone=public --add-port=12345/tcp --permanent\nsudo firewall-cmd --zone=public --remove-port=12345/tcp --permanent</code></pre>\n      </div>\n<p>Verify open ports:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">firewall-cmd --list-ports</code></pre>\n      </div>\n<p>Check the firewall status:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">sudo firewall-cmd --state</code></pre>\n      </div>\n<p>To view the status of the FirewallD daemon:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">sudo systemctl status firewalld</code></pre>\n      </div>\n<p>To reload a FirewallD configuration:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">sudo firewall-cmd --reload</code></pre>\n      </div>\n<h2 id="04-create-a-login"><a href="#04-create-a-login" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>04 Create a login</h2>\n<hr>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">sudo htpasswd -c /etc/nginx/.htpasswd USERNAME\nNew password: xxxxxxxxx\nRe-type new password: xxxxxxxxx</code></pre>\n      </div>\n<h2 id="05-nginxconf"><a href="#05-nginxconf" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>05 nginx.conf</h2>\n<p>/etc/nginx/nginx.conf</p>\n<div class="gatsby-highlight">\n      <pre class="language-nginx"><code class="language-nginx"><span class="token keyword">user</span> nginx<span class="token punctuation">;</span>\n<span class="token keyword">worker_processes</span> <span class="token number">8</span><span class="token punctuation">;</span>\n<span class="token keyword">error_log</span> <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>error<span class="token punctuation">.</span>log<span class="token punctuation">;</span>\n<span class="token keyword">pid</span> <span class="token operator">/</span>run<span class="token operator">/</span>nginx<span class="token punctuation">.</span><span class="token keyword">pid</span><span class="token punctuation">;</span>\n\n<span class="token keyword">events</span> <span class="token punctuation">{</span>\n    <span class="token keyword">worker_connections</span> <span class="token number">1024</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">http</span> <span class="token punctuation">{</span>\n    <span class="token keyword">log_format</span>  main  <span class="token string">\'$remote_addr - $remote_user [$time_local] "$request" \'</span>\n                      <span class="token string">\'$status $body_bytes_sent "$http_referer" \'</span>\n                      <span class="token string">\'"$http_user_agent" "$http_x_forwarded_for"\'</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">access_log</span>  <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>access<span class="token punctuation">.</span>log  main<span class="token punctuation">;</span>\n\n    <span class="token keyword">sendfile</span>            on<span class="token punctuation">;</span>\n    <span class="token keyword">tcp_nopush</span>          on<span class="token punctuation">;</span>\n    <span class="token keyword">tcp_nodelay</span>         on<span class="token punctuation">;</span>\n    <span class="token keyword">keepalive_timeout</span>   <span class="token number">65</span><span class="token punctuation">;</span>\n    <span class="token keyword">types_hash_max_size</span> <span class="token number">2048</span><span class="token punctuation">;</span>\n\t<span class="token keyword">gzip</span> on<span class="token punctuation">;</span>\n\t<span class="token keyword">gzip_vary</span> on<span class="token punctuation">;</span>\n\t<span class="token keyword">gzip_proxied</span> any<span class="token punctuation">;</span>\n\t<span class="token keyword">gzip_comp_level</span> <span class="token number">6</span><span class="token punctuation">;</span>\n\t<span class="token keyword">gzip_buffers</span> <span class="token number">16</span> <span class="token number">8</span>k<span class="token punctuation">;</span>\n\t<span class="token keyword">gzip_http_version</span> <span class="token number">1.1</span><span class="token punctuation">;</span>\n\t<span class="token keyword">gzip_types</span> text<span class="token operator">/</span>plain text<span class="token operator">/</span>css application<span class="token operator">/</span>json application<span class="token operator">/</span>x<span class="token operator">-</span>javascript text<span class="token operator">/</span>xml application<span class="token operator">/</span>xml application<span class="token operator">/</span>xml<span class="token operator">+</span>rss text<span class="token operator">/</span>javascript<span class="token punctuation">;</span>\n\n    <span class="token keyword">include</span>             <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>mime<span class="token punctuation">.</span><span class="token keyword">types</span><span class="token punctuation">;</span>\n    <span class="token keyword">default_type</span>        application<span class="token operator">/</span>octet<span class="token operator">-</span>stream<span class="token punctuation">;</span>\n\n    <span class="token comment"># Load modular configuration files from the /etc/nginx/conf.d directory.</span>\n    <span class="token comment"># See http://nginx.org/en/docs/ngx_core_module.html#include</span>\n    <span class="token comment"># for more information.</span>\n    <span class="token keyword">include</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token punctuation">.</span>d<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>conf<span class="token punctuation">;</span>\n\t<span class="token comment"># include /etc/nginx/sites-enabled/*;</span>\n\n\t<span class="token comment"># Hide nginx version token</span>\n\t<span class="token keyword">server_tokens</span> off<span class="token punctuation">;</span>\n\n\t<span class="token comment"># Configure buffer sizes</span>\n\t<span class="token keyword">client_body_buffer_size</span> <span class="token number">16</span>k<span class="token punctuation">;</span>\n\t<span class="token keyword">client_header_buffer_size</span> <span class="token number">1</span>k<span class="token punctuation">;</span>\n\t<span class="token keyword">client_max_body_size</span> <span class="token number">8</span>m<span class="token punctuation">;</span>\n\t<span class="token keyword">large_client_header_buffers</span> <span class="token number">4</span> <span class="token number">8</span>k<span class="token punctuation">;</span>\n\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<h2 id="06-virtualconf"><a href="#06-virtualconf" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>06 virtual.conf</h2>\n<p>/etc/nginx/conf.d/virtual.conf</p>\n<p>Set up virtual server instances for our 2 node/express apps, Elasticsearch and Kibana</p>\n<div class="gatsby-highlight">\n      <pre class="language-nginx"><code class="language-nginx"><span class="token comment"># redirect http/80 traffic to https/443 for our node apps</span>\n<span class="token keyword">server</span> <span class="token punctuation">{</span>\n       <span class="token keyword">listen</span>         <span class="token number">80</span><span class="token punctuation">;</span>\n       <span class="token keyword">listen</span>    <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">80</span><span class="token punctuation">;</span>\n       <span class="token keyword">server_name</span>    example<span class="token punctuation">.</span>de example2<span class="token punctuation">.</span>de<span class="token punctuation">;</span>\n       <span class="token keyword">return</span>         <span class="token number">301</span> <span class="token keyword">https</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token variable">$server_name</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment"># point to our first node app that is running on port 8888 and accept calls over https://example.de:443</span>\n<span class="token keyword">upstream</span> myApp_en <span class="token punctuation">{</span>\n\t<span class="token comment"># point to the running node</span>\n\t<span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8888</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">server</span> <span class="token punctuation">{</span>\n\t<span class="token comment"># users using this port and domain will be directed to the node app defined above</span>\n\t<span class="token comment"># listen 80 default_server;</span>\n\t<span class="token comment"># listen [::]:80 default_server ipv6only=on;</span>\n\t<span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">ssl</span> http2 default_server<span class="token punctuation">;</span>\n\t<span class="token keyword">listen</span> <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">443</span> <span class="token keyword">ssl</span> http2 default_server<span class="token punctuation">;</span>\n\t<span class="token comment"># If you want to run more then one node app, they either have to be assigned different web domains (server_name) or ports!</span>\n\t<span class="token keyword">server_name</span> example<span class="token punctuation">.</span>de<span class="token punctuation">;</span>\n\n\t<span class="token comment"># Adding the SSL Certificates</span>\n    <span class="token keyword">ssl_prefer_server_ciphers</span> on<span class="token punctuation">;</span>\n\t<span class="token keyword">ssl_ciphers</span> EECDH<span class="token operator">+</span>CHACHA20<span class="token punctuation">:</span>EECDH<span class="token operator">+</span>AES128<span class="token punctuation">:</span>RSA<span class="token operator">+</span>AES128<span class="token punctuation">:</span>EECDH<span class="token operator">+</span>AES256<span class="token punctuation">:</span>RSA<span class="token operator">+</span>AES256<span class="token punctuation">:</span>EECDH<span class="token operator">+</span><span class="token number">3</span>DES<span class="token punctuation">:</span>RSA<span class="token operator">+</span><span class="token number">3</span>DES<span class="token punctuation">:</span><span class="token operator">!</span>MD5<span class="token punctuation">;</span>\n\t<span class="token keyword">ssl_dhparam</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span>dhparam<span class="token punctuation">.</span>pem<span class="token punctuation">;</span>\n\t<span class="token keyword">ssl_certificate</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span>nginx<span class="token operator">-</span>selfsigned<span class="token punctuation">.</span>crt<span class="token punctuation">;</span>\n\t<span class="token keyword">ssl_certificate_key</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span>nginx<span class="token operator">-</span>selfsigned<span class="token punctuation">.</span>key<span class="token punctuation">;</span>\n\n\t<span class="token comment"># set the default public directory for your node</span>\n\t<span class="token keyword">root</span> <span class="token operator">/</span>opt<span class="token operator">/</span>myApp_en<span class="token operator">/</span>build<span class="token operator">/</span>public<span class="token punctuation">;</span>\n\n\t<span class="token comment"># Optimizing Nginx for Best Performance</span>\n\t<span class="token keyword">ssl_session_cache</span> shared<span class="token punctuation">:</span><span class="token keyword">SSL</span><span class="token punctuation">:</span><span class="token number">5</span>m<span class="token punctuation">;</span>\n    <span class="token keyword">ssl_session_timeout</span> <span class="token number">1</span>h<span class="token punctuation">;</span>\n\n\t<span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>\n    \t<span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_set_header</span> Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>NginX<span class="token operator">-</span><span class="token keyword">Proxy</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_http_version</span> <span class="token number">1.1</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_set_header</span> Connection <span class="token string">"upgrade"</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_max_temp_file_size</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\t\t<span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>myApp_en<span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_redirect</span> off<span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_read_timeout</span> <span class="token number">240</span>s<span class="token punctuation">;</span>\n\t\t<span class="token comment"># Authentication can be activated during development</span>\n\t\t<span class="token comment"># auth_basic "Username and Password are required";</span>\n\t\t<span class="token comment"># the user login has to be generated</span>\n\t\t<span class="token comment"># auth_basic_user_file /etc/nginx/.htpasswd;</span>\n\t<span class="token punctuation">}</span>\n\n\t<span class="token comment"># use NGINX to cache static resources that are requested regularly</span>\n\t<span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> \\<span class="token punctuation">.</span><span class="token punctuation">(</span>css<span class="token operator">|</span>js<span class="token operator">|</span>jpg<span class="token operator">|</span>png<span class="token operator">|</span>ico<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>\n\t\t<span class="token keyword">expires</span> <span class="token number">168</span>h<span class="token punctuation">;</span>\n\t<span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n\n<span class="token comment"># point to our second node app that is running on port 8484 and accept calls over https://example2.de:443</span>\n<span class="token keyword">upstream</span> myApp_de <span class="token punctuation">{</span>\n\t<span class="token comment"># point to the second running node</span>\n\t<span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8484</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">server</span> <span class="token punctuation">{</span>\n\t<span class="token comment"># users using this port and domain will be directed to the second node app</span>\n\t<span class="token comment"># listen 80;</span>\n\t<span class="token comment"># listen [::]:8080 ipv6only=on;</span>\n\t<span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">ssl</span> http2<span class="token punctuation">;</span>\n\t<span class="token comment"># The IPv6 address is unique - only one app can use the default port 443!</span>\n\t<span class="token keyword">listen</span> <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">444</span> <span class="token keyword">ssl</span> http2<span class="token punctuation">;</span>\n\t<span class="token keyword">server_name</span> example2<span class="token punctuation">.</span>de<span class="token punctuation">;</span>\n\n\t<span class="token comment"># adding the SSL Certificates</span>\n    <span class="token keyword">ssl_prefer_server_ciphers</span> on<span class="token punctuation">;</span>\n\t<span class="token keyword">ssl_ciphers</span> EECDH<span class="token operator">+</span>CHACHA20<span class="token punctuation">:</span>EECDH<span class="token operator">+</span>AES128<span class="token punctuation">:</span>RSA<span class="token operator">+</span>AES128<span class="token punctuation">:</span>EECDH<span class="token operator">+</span>AES256<span class="token punctuation">:</span>RSA<span class="token operator">+</span>AES256<span class="token punctuation">:</span>EECDH<span class="token operator">+</span><span class="token number">3</span>DES<span class="token punctuation">:</span>RSA<span class="token operator">+</span><span class="token number">3</span>DES<span class="token punctuation">:</span><span class="token operator">!</span>MD5<span class="token punctuation">;</span>\n\t<span class="token keyword">ssl_dhparam</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span>dhparam<span class="token punctuation">.</span>pem<span class="token punctuation">;</span>\n\t<span class="token keyword">ssl_certificate</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span>nginx<span class="token operator">-</span>selfsigned<span class="token punctuation">.</span>crt<span class="token punctuation">;</span>\n\t<span class="token keyword">ssl_certificate_key</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span>nginx<span class="token operator">-</span>selfsigned<span class="token punctuation">.</span>key<span class="token punctuation">;</span>\n\n\t<span class="token comment"># set the default public directory for your second node</span>\n\t<span class="token keyword">root</span> <span class="token operator">/</span>opt<span class="token operator">/</span>myApp_de<span class="token operator">/</span>build<span class="token operator">/</span>public<span class="token punctuation">;</span>\n\n\t<span class="token comment"># optimizing Nginx for Best Performance</span>\n\t<span class="token keyword">ssl_session_cache</span> shared<span class="token punctuation">:</span><span class="token keyword">SSL</span><span class="token punctuation">:</span><span class="token number">5</span>m<span class="token punctuation">;</span>\n    <span class="token keyword">ssl_session_timeout</span> <span class="token number">1</span>h<span class="token punctuation">;</span>\n\n\t<span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>\n    \t<span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_set_header</span> Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>NginX<span class="token operator">-</span><span class="token keyword">Proxy</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_http_version</span> <span class="token number">1.1</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_set_header</span> Connection <span class="token string">"upgrade"</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_max_temp_file_size</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\t\t<span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>myApp_de<span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_redirect</span> off<span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_read_timeout</span> <span class="token number">240</span>s<span class="token punctuation">;</span>\n\t\t<span class="token comment"># auth_basic "Username and Password are required";</span>\n\t\t<span class="token comment"># auth_basic_user_file /etc/nginx/.htpasswd;</span>\n\t<span class="token punctuation">}</span>\n\n\t<span class="token comment"># use NGINX to cache static resources that are requested regularly</span>\n\t<span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> \\<span class="token punctuation">.</span><span class="token punctuation">(</span>css<span class="token operator">|</span>js<span class="token operator">|</span>jpg<span class="token operator">|</span>png<span class="token operator">|</span>ico<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>\n\t\t<span class="token keyword">expires</span> <span class="token number">168</span>h<span class="token punctuation">;</span>\n\t<span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n\n<span class="token comment"># point to our Elasticsearch database that is running on port 9200 and accept calls over 8080</span>\n<span class="token keyword">upstream</span> elasticsearch <span class="token punctuation">{</span>\n\t<span class="token comment"># point to the second running node</span>\n\t<span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">9200</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">server</span> <span class="token punctuation">{</span>\n\t<span class="token comment"># users using this port will be directed to Elasticsearch</span>\n\t<span class="token keyword">listen</span> <span class="token number">8080</span><span class="token punctuation">;</span>\n\t<span class="token keyword">listen</span> <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">8080</span> ipv6only<span class="token operator">=</span>on<span class="token punctuation">;</span>\n\t<span class="token keyword">server_name</span> SERVER_IP_ADDRESS<span class="token punctuation">;</span>\n\n\t<span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>\n    \t<span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_set_header</span> Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>NginX<span class="token operator">-</span><span class="token keyword">Proxy</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_http_version</span> <span class="token number">1.1</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_set_header</span> Connection <span class="token string">"upgrade"</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_max_temp_file_size</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\t\t<span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>elasticsearch<span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_redirect</span> off<span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_read_timeout</span> <span class="token number">240</span>s<span class="token punctuation">;</span>\n\t\t<span class="token keyword">auth_basic</span> <span class="token string">"Username and Password are required"</span><span class="token punctuation">;</span>\n\t\t<span class="token keyword">auth_basic_user_file</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span><span class="token punctuation">.</span>htpasswd<span class="token punctuation">;</span>\n\t<span class="token punctuation">}</span>\n\n<span class="token punctuation">}</span>\n\n<span class="token comment"># point to our Kibana instance that is running on port 5601 and accept calls over 8181</span>\n<span class="token keyword">server</span> <span class="token punctuation">{</span>\n\t<span class="token comment"># users using this port and will be directed to Elasticsearch/Kibana</span>\n\t<span class="token keyword">listen</span> <span class="token number">8181</span><span class="token punctuation">;</span>\n\t<span class="token keyword">listen</span> <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">8181</span> ipv6only<span class="token operator">=</span>on<span class="token punctuation">;</span>\n\n\t<span class="token keyword">server_name</span> SERVER_IP_ADDRESS<span class="token punctuation">;</span>\n\n\t<span class="token keyword">auth_basic</span> <span class="token string">"Restricted Access"</span><span class="token punctuation">;</span>\n\t<span class="token keyword">auth_basic_user_file</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span><span class="token punctuation">.</span>htpasswd<span class="token punctuation">;</span>\n\n\t<span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>\n    \t<span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">5601</span><span class="token punctuation">;</span>\n        <span class="token keyword">proxy_http_version</span> <span class="token number">1.1</span><span class="token punctuation">;</span>\n        <span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>\n        <span class="token keyword">proxy_set_header</span> Connection <span class="token string">\'upgrade\'</span><span class="token punctuation">;</span>\n        <span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span><span class="token punctuation">;</span>\n        <span class="token keyword">proxy_cache_bypass</span> <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>        \n\t<span class="token punctuation">}</span>\n\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<h2 id="07-godaddy-certs"><a href="#07-godaddy-certs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>07 GoDaddy Certs</h2>\n<p>When you ordered a wildcard certificate from goDaddy you will receive two files: Your SSL Certificate with a random name (Ex. 93rfs8dhf834hts.crt) and the GoDaddy intermediate certificate bundle (gd_bundle-g2-g1.crt). Lets install them on our server.</p>\n<h3 id="generate-a-csr-and-private-key"><a href="#generate-a-csr-and-private-key" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Generate a CSR and Private Key</h3>\n<p>Create a folder to put all our ssl certificates:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">mkdir /etc/nginx/ssl\ncd /etc/nginx/ssl</code></pre>\n      </div>\n<p>Generate our private key, called example.com.key, and a CSR, called example.com.csr:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">openssl req -newkey rsa:2048 -nodes -keyout example.com.key -out example.com.csr</code></pre>\n      </div>\n<p>At this point, you will be prompted for several lines of information that will be included in your certificate request. The most important part is the Common Name field which should match the name that you want to use your certificate with — for example, example.com, www.example.com, or (for a wildcard certificate request) [STAR].example.com.</p>\n<h3 id="download-your-key-from-godaddy"><a href="#download-your-key-from-godaddy" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Download your key from GoDaddy</h3>\n<p>The files you receive will look something like this:</p>\n<ul>\n<li>93rfs8dhf834hts.crt</li>\n<li>gd_bundle-g2-g1.crt</li>\n</ul>\n<p>Upload both to /etc/nginx/ssl directory and rename the first one to your domain name example.com.cst</p>\n<h3 id="install-certificate-on-web-server"><a href="#install-certificate-on-web-server" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Install Certificate On Web Server</h3>\n<p>You can use the following command to create a combined file from both GoDaddy files called example.com.chained.crt:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">cat example.com.crt gd_bundle-g2-g1.crt &gt; example.com.chained.crt</code></pre>\n      </div>\n<p>And now you should change the access permission to this folder:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">cd /etc/nginx\nsudo chmod -R 600 ssl/</code></pre>\n      </div>\n<p>To complete the configuration you have to make sure your NGINX config points to the right cert file and to the private key you generated earlier. Add the following lines inside the server block of your NGINX config:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text"># adding the SSL Certificates\n  ssl_prefer_server_ciphers on;\n  ssl_ciphers EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;\n\tssl_certificate /etc/nginx/ssl/example.com.chained.crt;\n\tssl_certificate_key /etc/nginx/ssl/example.com.key;</code></pre>\n      </div>\n<p>Always test your configuration first:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">nginx -t</code></pre>\n      </div>\n<p>and then reload:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">service nginx reload</code></pre>\n      </div>\n<h2 id="08-letsencrypt-and-certbot"><a href="#08-letsencrypt-and-certbot" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>08 LetsEncrypt and Certbot</h2>\n<h3 id="install-certbot-on-centos-7"><a href="#install-certbot-on-centos-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Install Certbot on CentOS 7</h3>\n<p><strong>yum install certbot-nginx</strong></p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">Dependencies Resolved\n\n==============================================================================================\n Package                         Arch             Version                Repository      Size\n==============================================================================================\nInstalling:\n python2-certbot-nginx           noarch           0.14.1-1.el7           epel            52 k\nInstalling for dependencies:\n pyparsing                       noarch           1.5.6-9.el7            base            94 k\n\nTransaction Summary\n==============================================================================================\nInstall  1 Package (+1 Dependent package)\n\nComplete!</code></pre>\n      </div>\n<h3 id="run-certbot"><a href="#run-certbot" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Run Certbot</h3>\n<p><strong>certbot —nginx -d wiki.instar.fr</strong></p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">Saving debug log to /var/log/letsencrypt/letsencrypt.log\nEnter email address (used for urgent renewal and security notices) (Enter &#39;c&#39; to\ncancel):</code></pre>\n      </div>\n<p><strong>myemail@email.com</strong></p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">-------------------------------------------------------------------------------\nPlease read the Terms of Service at\nhttps://letsencrypt.org/documents/LE-SA-v1.1.1-August-1-2016.pdf. You must agree\nin order to register with the ACME server at\nhttps://acme-v01.api.letsencrypt.org/directory\n-------------------------------------------------------------------------------</code></pre>\n      </div>\n<p><strong>(A)gree/(C)ancel: A</strong></p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">Starting new HTTPS connection (1): supporters.eff.org\nObtaining a new certificate\nPerforming the following challenges:\ntls-sni-01 challenge for wiki.instar.fr\nWaiting for verification...\nCleaning up challenges\nDeployed Certificate to VirtualHost /etc/nginx/conf.d/virtual.conf for set([&#39;wiki.instar.fr&#39;])\n\nPlease choose whether HTTPS access is required or optional.\n-------------------------------------------------------------------------------\n1: Easy - Allow both HTTP and HTTPS access to these sites\n2: Secure - Make all requests redirect to secure HTTPS access\n-------------------------------------------------------------------------------\nSelect the appropriate number [1-2] then [enter] (press &#39;c&#39; to cancel): 2\nThe appropriate server block is already redirecting traffic. To enable redirect anyway, uncomment the redirect lines in /etc/nginx/conf.d/virtual.conf.\n-------------------------------------------------------------------------------\nCongratulations! You have successfully enabled https://wiki.instar.fr\n-------------------------------------------------------------------------------</code></pre>\n      </div>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">IMPORTANT NOTES:\n - Congratulations! Your certificate and chain have been saved at\n   /etc/letsencrypt/live/wiki.instar.fr/fullchain.pem. Your cert will\n   expire on 2017-12-13. To obtain a new or tweaked version of this\n   certificate in the future, simply run certbot again with the\n   &quot;certonly&quot; option. To non-interactively renew *all* of your\n   certificates, run &quot;certbot renew&quot;\n - Your account credentials have been saved in your Certbot\n   configuration directory at /etc/letsencrypt. You should make a\n   secure backup of this folder now. This configuration directory will\n   also contain certificates and private keys obtained by Certbot so\n   making regular backups of this folder is ideal.</code></pre>\n      </div>\n<h3 id="setting-up-auto-renewal"><a href="#setting-up-auto-renewal" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Setting Up Auto Renewal</h3>\n<h4 id="systemd"><a href="#systemd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Systemd</h4>\n<p>Go to <em>/etc/systemd/system/</em> and create the following two files</p>\n<p><em>certbot-nginx.service</em></p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">[Unit]\nDescription=Renew Certbot certificates (nginx)\nAfter=network-online.target\n\n[Service]\nType=oneshot\nExecStart=/usr/bin/certbot-2 renew --deploy-hook &quot;systemctl reload nginx&quot;</code></pre>\n      </div>\n<p><em>certbot-nginx.timer</em></p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">[Unit]\nDescription=Renew Certbot certificate (nginx)\n\n[Timer]\nOnCalendar=daily\nPersistent=true\nRandomizedDelaySec=86400\n\n[Install]\nWantedBy=multi-user.target</code></pre>\n      </div>\n<p>Now activate the service</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">$ systemctl daemon-reload\n$ systemctl start certbot-nginx.service  # to run manually\n$ systemctl enable --now certbot-nginx.timer  # to use the timer</code></pre>\n      </div>\n<h4 id="crond"><a href="#crond" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cron.d</h4>\n<p>Add Certbot renewal to Cron.d in /etc/cron.d - we want to run it twice daily at 13:22 and 04:17:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text"># Example of job definition:\n# .---------------- minute (0 - 59)\n# |  .------------- hour (0 - 23)\n# |  |  .---------- day of month (1 - 31)\n# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...\n# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat\n# |  |  |  |  |\n# *  *  *  *  * user-name command to be executed\n\n17 4 * * * /usr/bin/certbot-2 renew --quiet\n22 13 * * * /usr/bin/certbot-2 renew --quiet</code></pre>\n      </div>\n<h3 id="tls-sni-01-challenge-deactivated"><a href="#tls-sni-01-challenge-deactivated" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>TLS-SNI-01 challenge Deactivated</h3>\n<p>If you are receiving the following error when trying to add a certificate to your domain:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">Client with the currently selected authenticator does not support any combination of challenges that will satisfy the CA.</code></pre>\n      </div>\n<p>Follow the Instructions given <a href="https://community.letsencrypt.org/t/solution-client-with-the-currently-selected-authenticator-does-not-support-any-combination-of-challenges-that-will-satisfy-the-ca/49983">here</a> and if you’re serving files for that domain out of a directory on that server, you can run the following command:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">sudo certbot --authenticator webroot --webroot-path &lt;path to served directory&gt; --installer nginx -d &lt;domain&gt;</code></pre>\n      </div>\n<p>If you’re not serving files out of a directory on the server, you can temporarily stop your server while you obtain the certificate and restart it after Certbot has obtained the certificate. This would look like:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">sudo certbot --authenticator standalone --installer nginx -d &lt;domain&gt; --pre-hook &quot;service nginx stop&quot; --post-hook &quot;service nginx start&quot;</code></pre>\n      </div>\n<p>e.g.</p>\n<ol>\n<li>Create your virtual server conf - the given config below routes an node/express app running on localhost:7777 with a public directory in /opt/mysite-build/app :</li>\n</ol>\n<div class="gatsby-highlight">\n      <pre class="language-nginx"><code class="language-nginx"><span class="token keyword">server</span> <span class="token punctuation">{</span>\n       <span class="token keyword">listen</span>         <span class="token number">80</span><span class="token punctuation">;</span>\n       <span class="token keyword">listen</span>    <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">80</span><span class="token punctuation">;</span>\n       <span class="token keyword">server_name</span>    my<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>com<span class="token punctuation">;</span>\n       <span class="token keyword">return</span>         <span class="token number">301</span> <span class="token keyword">https</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token variable">$server_name</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">upstream</span> app_test <span class="token punctuation">{</span>\n\t<span class="token comment"># point to the running node</span>\n\t<span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">7777</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">server</span> <span class="token punctuation">{</span>\n\t<span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">ssl</span> http2<span class="token punctuation">;</span>\n\t<span class="token keyword">listen</span> <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">443</span> <span class="token keyword">ssl</span> http2<span class="token punctuation">;</span>\n\t<span class="token keyword">server_name</span> my<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>com<span class="token punctuation">;</span>\n\t\n\t<span class="token comment"># set the default public directory for your node</span>\n\t<span class="token keyword">root</span> <span class="token operator">/</span>opt<span class="token operator">/</span>mysite<span class="token operator">-</span>build<span class="token operator">/</span>app<span class="token punctuation">;</span>\n\t\n\t<span class="token comment"># Optimizing Nginx for Best Performance</span>\n\t<span class="token keyword">ssl_session_cache</span> shared<span class="token punctuation">:</span><span class="token keyword">SSL</span><span class="token punctuation">:</span><span class="token number">5</span>m<span class="token punctuation">;</span>\n    <span class="token keyword">ssl_session_timeout</span> <span class="token number">1</span>h<span class="token punctuation">;</span>\n\t\n\t<span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>\n    \t<span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_set_header</span> Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>NginX<span class="token operator">-</span><span class="token keyword">Proxy</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_http_version</span> <span class="token number">1.1</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_set_header</span> Connection <span class="token string">"upgrade"</span><span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_max_temp_file_size</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\t\t<span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>wiki2_test<span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_redirect</span> off<span class="token punctuation">;</span>\n    \t<span class="token keyword">proxy_read_timeout</span> <span class="token number">240</span>s<span class="token punctuation">;</span>\n\t<span class="token punctuation">}</span>\n\t\n\t<span class="token comment"># use NGINX to cache static resources that are requested regularly</span>\n\t<span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> \\<span class="token punctuation">.</span><span class="token punctuation">(</span>css<span class="token operator">|</span>js<span class="token operator">|</span>jpg<span class="token operator">|</span>png<span class="token operator">|</span>ico<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>\n\t\t<span class="token keyword">expires</span> <span class="token number">168</span>h<span class="token punctuation">;</span>\n\t<span class="token punctuation">}</span>\n\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>Test your your site by opening my.domain.com inside your browser - you should be automatically redirected to <a href="https://my.domain.com">https://my.domain.com</a> and be given a certificate warning. Click to proceed anyway to access your site.</p>\n<p>Now run:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">sudo certbot --authenticator webroot --webroot-path /opt/mysite-build/app --installer nginx -d my.domain.com</code></pre>\n      </div>\n<p>certbot will modify your NGINX config automatically!</p>',
fields:{slug:"/using-nginx-as-proxy-for-your-nodejs-apps/",prefix:"2017-10-01"},frontmatter:{title:"Using NGINX as proxy for your nodejs apps",subTitle:"We want to set up NGINX with http/2 to serve multiple node apps and an instance of Elasticsearch on a single centOS server",cover:{childImageSharp:{resize:{src:"/static/photo-34607920835_e26fff721f_o-cover-41796b4972f105a095559aaa10d92df1-ada8c.jpg"}}}}},author:{id:"E:/gatsby-starter-personal-blog/content/parts/author.md absPath of file >>> MarkdownRemark",html:'<p><strong>Mike Polinowski</strong> Proin ornare ligula eu tellus tempus elementum. Aenean <a href="/contact/">contact me</a> iaculis mi, nec blandit lacus interdum vitae. Vestibulum non nibh risus, a scelerisque purus. :hearts:</p>'},footnote:{id:"E:/gatsby-starter-personal-blog/content/parts/footnote.md absPath of file >>> MarkdownRemark",html:'<ul>\n<li>This is a personal Developer Blog</li>\n<li>Ξ</li>\n<li>built by <a href="https://github.com/mpolinowski">Mike Polinowski</a></li>\n<li>Ξ</li>\n<li>with <a href="https://www.gatsbyjs.org/">Gatsby</a> &#x26; <a href="https://reactjs.org">React</a></li>\n<li>Ξ</li>\n<li>source code on <a href="https://github.com/mpolinowski/mpolinowski.github.io">GitHub</a></li>\n<li>Ξ</li>\n<li>deliverd by <a href="https://pages.github.com">Github Pages</a></li>\n<li>Ξ</li>\n<li>photos from <a href="https://www.flickr.com/people/149680084@N06/">Flickr</a></li>\n</ul>'}},pathContext:{slug:"/using-nginx-as-proxy-for-your-nodejs-apps/"}}}});
//# sourceMappingURL=path---using-nginx-as-proxy-for-your-nodejs-apps-301d854c3daab8961f1b.js.map