{"componentChunkName":"component---src-templates-post-jsx","path":"/magento-2-and-varnish-6","result":{"data":{"mdx":{"id":"39c9768c-53bd-5cbf-bc55-42da95bb6468","body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"date\": \"2019-09-13\",\n  \"title\": \"Magento 2 and Varnish 6\",\n  \"categories\": [\"LINUX\", \"Magento\"]\n};\n\nvar makeShortcode = function makeShortcode(name) {\n  return function MDXDefaultShortcode(props) {\n    console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n    return mdx(\"div\", props);\n  };\n};\n\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, mdx(\"span\", _extends({\n    parentName: \"p\"\n  }, {\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"1024px\"\n    }\n  }), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"43%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  })), \"\\n    \", mdx(\"picture\", {\n    parentName: \"span\"\n  }, \"\\n        \", mdx(\"source\", _extends({\n    parentName: \"picture\"\n  }, {\n    \"srcSet\": [\"/static/fc79c9102f74b2dcd84b3f86225b0b93/8d3d1/photo-kt456d_645dhfh6dgjkhg4_d.webp 256w\", \"/static/fc79c9102f74b2dcd84b3f86225b0b93/354cf/photo-kt456d_645dhfh6dgjkhg4_d.webp 512w\", \"/static/fc79c9102f74b2dcd84b3f86225b0b93/44907/photo-kt456d_645dhfh6dgjkhg4_d.webp 1024w\", \"/static/fc79c9102f74b2dcd84b3f86225b0b93/9579c/photo-kt456d_645dhfh6dgjkhg4_d.webp 1500w\"],\n    \"sizes\": \"(max-width: 1024px) 100vw, 1024px\",\n    \"type\": \"image/webp\"\n  })), \"\\n        \", mdx(\"source\", _extends({\n    parentName: \"picture\"\n  }, {\n    \"srcSet\": [\"/static/fc79c9102f74b2dcd84b3f86225b0b93/b95e4/photo-kt456d_645dhfh6dgjkhg4_d.jpg 256w\", \"/static/fc79c9102f74b2dcd84b3f86225b0b93/1779b/photo-kt456d_645dhfh6dgjkhg4_d.jpg 512w\", \"/static/fc79c9102f74b2dcd84b3f86225b0b93/87945/photo-kt456d_645dhfh6dgjkhg4_d.jpg 1024w\", \"/static/fc79c9102f74b2dcd84b3f86225b0b93/9d81f/photo-kt456d_645dhfh6dgjkhg4_d.jpg 1500w\"],\n    \"sizes\": \"(max-width: 1024px) 100vw, 1024px\",\n    \"type\": \"image/jpeg\"\n  })), \"\\n        \", mdx(\"img\", _extends({\n    parentName: \"picture\"\n  }, {\n    \"className\": \"gatsby-resp-image-image\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\",\n      \"boxShadow\": \"inset 0px 0px 0px 400px white\"\n    },\n    \"src\": \"/static/fc79c9102f74b2dcd84b3f86225b0b93/87945/photo-kt456d_645dhfh6dgjkhg4_d.jpg\",\n    \"alt\": \"Victoria Harbour, Hongkong\",\n    \"title\": \"\"\n  })), \"\\n      \"), \"\\n  \")), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#install-varnish-6-on-debian-10\"\n  }), \"Install Varnish 6 on Debian 10\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#configure-nginx\"\n  }), \"Configure NGINX\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#modify-the-varnish-system-configuration\"\n  }), \"Modify the Varnish system configuration\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#modify-defaultvcl\"\n  }), \"Modify default.vcl\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#configure-magento-to-use-varnish\"\n  }), \"Configure Magento to use Varnish\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#export-a-varnish-configuration-file\"\n  }), \"Export a Varnish Configuration File\"))), mdx(\"h2\", {\n    \"id\": \"install-varnish-6-on-debian-10\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"href\": \"#install-varnish-6-on-debian-10\",\n    \"aria-label\": \"install varnish 6 on debian 10 permalink\",\n    \"className\": \"anchor before\"\n  }), mdx(\"svg\", _extends({\n    parentName: \"a\"\n  }, {\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }), mdx(\"path\", _extends({\n    parentName: \"svg\"\n  }, {\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  })))), \"Install Varnish 6 on Debian 10\"), mdx(\"p\", null, \"In order to get \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://varnish-cache.org/docs/6.0/installation/install.html\",\n    \"target\": \"_blank\",\n    \"rel\": \"nofollow noopener noreferrer\"\n  }), \"Varnish\"), \" up and running type sudo apt-get install varnish. Enter the following command to display the version of Varnish you are running:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-bash\"\n  }), \"varnishd -V\\nvarnishd (varnish-6.1.1 revision efc2f6c1536cf2272e471f5cff5f145239b19460)\\nCopyright (c) 2006 Verdens Gang AS\\nCopyright (c) 2006-2015 Varnish Software AS\\n\")), mdx(\"h2\", {\n    \"id\": \"configure-nginx\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"href\": \"#configure-nginx\",\n    \"aria-label\": \"configure nginx permalink\",\n    \"className\": \"anchor before\"\n  }), mdx(\"svg\", _extends({\n    parentName: \"a\"\n  }, {\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }), mdx(\"path\", _extends({\n    parentName: \"svg\"\n  }, {\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  })))), \"Configure NGINX\"), mdx(\"p\", null, \"Configure your web server to listen on a port other than the default port \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"80\"), \" because Varnish responds directly to incoming HTTP requests, not the web server. In the sections that follow, we use port \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"8080\"), \" as an example:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-bash\"\n  }), \"nano /etc/nginx/sites-available/magento.conf\\n\")), mdx(\"p\", null, \"Change the server to listen to port \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"8080\"), \":\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js\"\n  }), \"upstream fastcgi_backend {\\n  server  unix:/run/php/php7.2-fpm.sock;\\n}\\n\\nserver {\\n\\n  listen 8080 default_server;\\n  server_name static.206.80.47.78.clients.your-server.de;\\n  set $MAGE_ROOT /var/www/html/magento;\\n  include /var/www/html/magento/nginx.conf.sample;\\n}\\n\")), mdx(\"p\", null, \"Test and reload NGINX:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-bash\"\n  }), \"nginx -t\\nservice nginx reload\\n\")), mdx(\"h2\", {\n    \"id\": \"modify-the-varnish-system-configuration\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"href\": \"#modify-the-varnish-system-configuration\",\n    \"aria-label\": \"modify the varnish system configuration permalink\",\n    \"className\": \"anchor before\"\n  }), mdx(\"svg\", _extends({\n    parentName: \"a\"\n  }, {\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }), mdx(\"path\", _extends({\n    parentName: \"svg\"\n  }, {\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  })))), \"Modify the Varnish system configuration\"), mdx(\"p\", null, \"As a user with root privileges, open your Vanish configuration file in a text editor:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-bash\"\n  }), \"nano /etc/default/varnish\\n\")), mdx(\"p\", null, \"Set the Varnish listen port to 80:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js\"\n  }), \"VARNISH_LISTEN_PORT=80\\n\")), mdx(\"p\", null, \"Make sure that DAEMON_OPTS contains the correct listening port for the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"-a\"), \" parameter:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js\"\n  }), \"DAEMON_OPTS=\\\"-a :80 \\\\\\n             -T localhost:6082 \\\\\\n             -f /etc/varnish/default.vcl \\\\\\n             -S /etc/varnish/secret \\\\\\n             -s malloc,256m\\\"\\n\")), mdx(\"p\", null, \"Save your changes to the Varnish configuration file and exit the text editor.\"), mdx(\"h2\", {\n    \"id\": \"modify-defaultvcl\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"href\": \"#modify-defaultvcl\",\n    \"aria-label\": \"modify defaultvcl permalink\",\n    \"className\": \"anchor before\"\n  }), mdx(\"svg\", _extends({\n    parentName: \"a\"\n  }, {\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }), mdx(\"path\", _extends({\n    parentName: \"svg\"\n  }, {\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  })))), \"Modify default.vcl\"), mdx(\"p\", null, \"This section discusses how to provide minimal configuration so Varnish returns HTTP response headers. This enables you to verify Varnish works before you configure Magento to use Varnish.\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Back up default.vcl:\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-bash\"\n  }), \"cp /etc/varnish/default.vcl /etc/varnish/default.vcl.bak\\n\")), mdx(\"p\", null, \"Open \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/etc/varnish/default.vcl\"), \" in a text editor and locate the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"backend default\"), \" and replace the value of .host with the fully qualified hostname or IP address and listen port of the Varnish backend or origin server; that is, the server providing the content Varnish will accelerate. Replace the value of .port with the web server\\u2019s listen port:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js\"\n  }), \"backend default {\\n    .host = \\\"my.domain.com\\\";\\n    .port = \\\"8080\\\";\\n}\\n\")), mdx(\"p\", null, \"Save your changes to default.vcl and exit the text editor and restart Varnish:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-bash\"\n  }), \"service varnish restart\\n\")), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Unfortunatly\"), \" this did not change the Port Varnish was running on:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-bash\"\n  }), \"netstat -tulpn | grep varnish\\ntcp        0      0 0.0.0.0:6081            0.0.0.0:*               LISTEN      1634/varnishd       \\ntcp        0      0 127.0.0.1:6082          0.0.0.0:*               LISTEN      1634/varnishd       \\ntcp6       0      0 :::6081                 :::*                    LISTEN      1634/varnishd\\n\")), mdx(\"p\", null, mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://serverfault.com/questions/824389/varnish-daemon-not-listening-on-configured-port/824399\",\n    \"target\": \"_blank\",\n    \"rel\": \"nofollow noopener noreferrer\"\n  }), \"Following this guide\"), \", applying changes to the default service is best done by creating a new file \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/etc/systemd/system/varnish.service.d/customexec.conf\"), \":\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-bash\"\n  }), \"# create the drop in directory\\nmkdir /etc/systemd/system/varnish.service.d\\n# create the drop in file. The name is irrelevant, as long as it ends in .conf\\nnano /etc/systemd/system/varnish.service.d/customexec.conf\\n\")), mdx(\"p\", null, \"Here you only need to add the settings you want do change, everything else will be loaded from the default definition file.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-bash\"\n  }), \"[Service]\\nExecStart=/usr/sbin/varnishd -j unix,user=vcache -F -a :80 -T localhost:6082 -f /etc/varnish/default.vcl -S /etc/varnish/secret -s malloc,256m\\n\")), mdx(\"p\", null, \"Afterwards, tell systemctl to reload it's config files and to restart the service\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-bash\"\n  }), \"systemctl daemon-reload\\nservice varnish restart\\n\")), mdx(\"p\", null, \"Mow I received an error message:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-bash\"\n  }), \"service varnish restart\\nFailed to restart varnish.service: Unit varnish.service has a bad unit file setting.\\nSee system logs and 'systemctl status varnish.service' for details.\\n\\nsystemctl status varnish.service\\nWarning: The unit file, source configuration file or drop-ins of varnish.service changed on disk\\u25CF varnish.service - Varnish HTTP accelerator\\n   Loaded: bad-setting (Reason: Unit varnish.service has a bad unit file setting.)\\n  Drop-In: /etc/systemd/system/varnish.service.d\\n           \\u2514\\u2500customexec.conf\\n   Active: active (running) since Fri 2020-02-07 11:10:15 CET; 33min ago\\n     Docs: https://www.varnish-cache.org/docs/6.1/\\n           man:varnishd\\n Main PID: 1634 (varnishd)\\n    Tasks: 217 (limit: 4915)\\n   Memory: 71.4M\\n   CGroup: /system.slice/varnish.service\\n           \\u251C\\u25001634 /usr/sbin/varnishd -j unix,user=vcache -F -a :6081 -T localhost:6082 -f /etc/v           \\u2514\\u25001646 /usr/sbin/varnishd -j unix,user=vcache -F -a :6081 -T localhost:6082 -f /etc/v\\nFeb 07 11:10:15 Magento2 systemd[1]: Started Varnish HTTP accelerator.\\nFeb 07 11:10:16 Magento2 varnishd[1634]: Debug: Version: varnish-6.1.1 revision efc2f6c1536cf227Feb 07 11:10:16 Magento2 varnishd[1634]: Debug: Platform: Linux,4.19.0-6-amd64,x86_64,-junix,-smFeb 07 11:10:16 Magento2 varnishd[1634]: Version: varnish-6.1.1 revision efc2f6c1536cf2272e471f5Feb 07 11:10:16 Magento2 varnishd[1634]: Platform: Linux,4.19.0-6-amd64,x86_64,-junix,-smalloc,-Feb 07 11:10:16 Magento2 varnishd[1634]: Debug: Child (1646) Started\\nFeb 07 11:10:16 Magento2 varnishd[1634]: Child (1646) Started\\nFeb 07 11:10:16 Magento2 varnishd[1634]: Info: Child (1646) said Child starts\\nFeb 07 11:10:16 Magento2 varnishd[1634]: Child (1646) said Child starts\\nFeb 07 11:43:32 Magento2 systemd[1]: varnish.service: Service has more than one ExecStart= setti\\n\")), mdx(\"p\", null, \"The duplicated \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ExecStart\"), \" line is in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/lib/systemd/system/varnish.service\"), \":\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {}), \"cat /lib/systemd/system/varnish.service\\n[Unit]\\nDescription=Varnish HTTP accelerator\\nDocumentation=https://www.varnish-cache.org/docs/6.1/ man:varnishd\\n\\n[Service]\\nType=simple\\nLimitNOFILE=131072\\nLimitMEMLOCK=82000\\nExecStart=/usr/sbin/varnishd -j unix,user=vcache -F -a :6081 -T localhost:6082 -f /etc/varnish/default.vcl -S /etc/varnish/secret -s malloc,256m\\nExecReload=/usr/share/varnish/varnishreload\\nProtectSystem=full\\nProtectHome=true\\nPrivateTmp=true\\nPrivateDevices=true\\n\\n[Install]\\nWantedBy=multi-user.target\\n\")), mdx(\"p\", null, \"Note that the drop-in should have an empty \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ExecStart=\"), \" to prevent this problem:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-bash\"\n  }), \"[Service]\\nExecStart=\\nExecStart=/usr/sbin/varnishd -j unix,user=vcache -F -a :80 -T localhost:6082 -f /etc/varnish/default.vcl -S /etc/varnish/secret -s malloc,256m\\n\")), mdx(\"p\", null, \"Varnish is now running on port 80:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-bash\"\n  }), \"netstat -tulpn | grep varnish\\ntcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      2972/varnishd       \\ntcp        0      0 127.0.0.1:6082          0.0.0.0:*               LISTEN      2972/varnishd       \\ntcp6       0      0 :::80                   :::*                    LISTEN      2972/varnishd\\n\")), mdx(\"p\", null, \"And I am able to access the Magento store again on port 80. You can check that your shop is served by Varnish by querying the HTTP header of your page:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-bash\"\n  }), \"curl -I http://my.domain.com/\\nHTTP/1.1 200 OK\\nServer: nginx/1.14.2\\nDate: Fri, 07 Feb 2020 12:46:23 GMT\\nContent-Type: text/html; charset=UTF-8\\nSet-Cookie: X-Magento-Vary=6b1086e51dc44ada73095007287c835c2e8a8cb2; expires=Fri, 07-Feb-2020 13:46:23 GMT; Max-Age=3600; path=/; HttpOnly\\nX-Magento-Cache-Control: max-age=86400, public, s-maxage=86400\\nX-Magento-Cache-Debug: MISS\\nX-Magento-Tags: store,cms_b,FPC\\nPragma: no-cache\\nCache-Control: max-age=0, must-revalidate, no-cache, no-store\\nExpires: Thu, 07 Feb 2019 12:46:23 GMT\\nX-Content-Type-Options: nosniff\\nX-XSS-Protection: 1; mode=block\\nX-Frame-Options: SAMEORIGIN\\nContent-Encoding: gzip\\nVary: Accept-Encoding\\nX-Varnish: 98400\\nAge: 0\\nVia: 1.1 varnish (Varnish/6.1)\\nConnection: keep-alive\\n\")), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"Before you can look at headers, you must set Magento for developer mode. You can also use the \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://devdocs.magento.com/guides/v2.3/config-guide/cli/config-cli-subcommands-mode.html#change-to-developer-mode\",\n    \"target\": \"_blank\",\n    \"rel\": \"nofollow noopener noreferrer\"\n  }), \"magento deploy:mode:set\"), \" command.\")), mdx(\"p\", null, \"Make sure Varnish is running then enter the following command on the Varnish server and click on a link on your website:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-bash\"\n  }), \"varnishlog\\n\")), mdx(\"h2\", {\n    \"id\": \"configure-magento-to-use-varnish\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"href\": \"#configure-magento-to-use-varnish\",\n    \"aria-label\": \"configure magento to use varnish permalink\",\n    \"className\": \"anchor before\"\n  }), mdx(\"svg\", _extends({\n    parentName: \"a\"\n  }, {\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }), mdx(\"path\", _extends({\n    parentName: \"svg\"\n  }, {\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  })))), \"Configure Magento to use Varnish\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Log in to the Magento Admin as an administrator.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Click \", mdx(\"strong\", {\n    parentName: \"li\"\n  }, \"Stores\"), \" > \", mdx(\"strong\", {\n    parentName: \"li\"\n  }, \"Configuration\"), \" > \", mdx(\"strong\", {\n    parentName: \"li\"\n  }, \"Advanced\"), \" > \", mdx(\"strong\", {\n    parentName: \"li\"\n  }, \"System\"), \" > \", mdx(\"strong\", {\n    parentName: \"li\"\n  }, \"Full Page Cache\"), \".\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"From the Caching Application list, click Varnish Caching.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Enter a value in the TTL for public content field.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Expand Varnish Configuration and enter the following information:\")), mdx(\"table\", null, mdx(\"thead\", {\n    parentName: \"table\"\n  }, mdx(\"tr\", {\n    parentName: \"thead\"\n  }, mdx(\"th\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": null\n  }), \"Field\"), mdx(\"th\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": null\n  }), \"Description\"))), mdx(\"tbody\", {\n    parentName: \"table\"\n  }, mdx(\"tr\", {\n    parentName: \"tbody\"\n  }, mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": null\n  }), \"Access list\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": null\n  }), \"Enter the fully qualified hostname, IP address, or Classless Inter-Domain Routing (CIDR) notation IP address range for which to invalidate content.  \", mdx(\"a\", _extends({\n    parentName: \"td\"\n  }, {\n    \"href\": \"https://www.varnish-cache.org/docs/3.0/tutorial/purging.html\",\n    \"target\": \"_blank\",\n    \"rel\": \"nofollow noopener noreferrer\"\n  }), \"More information\"))), mdx(\"tr\", {\n    parentName: \"tbody\"\n  }, mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": null\n  }), \"Backend host\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": null\n  }), \"Enter the fully qualified hostname or IP address and listen port of the Varnish backend or origin server; that is, the server providing the content Varnish will accelerate. Typically, this is your web server. \", mdx(\"a\", _extends({\n    parentName: \"td\"\n  }, {\n    \"href\": \"https://www.varnish-cache.org/docs/trunk/users-guide/vcl-backends.html\",\n    \"target\": \"_blank\",\n    \"rel\": \"nofollow noopener noreferrer\"\n  }), \"More information\"))), mdx(\"tr\", {\n    parentName: \"tbody\"\n  }, mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": null\n  }), \"Backend port\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": null\n  }), \"Origin server's listen port.\")), mdx(\"tr\", {\n    parentName: \"tbody\"\n  }, mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": null\n  }), \"Grace period\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": null\n  }), \"The grace period determines how long Varnish serves stale content if the backend is not responsive. The default value is 300 seconds.\")))), mdx(\"p\", null, mdx(\"span\", _extends({\n    parentName: \"p\"\n  }, {\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"972px\"\n    }\n  }), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"87.34567901234568%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  })), \"\\n    \", mdx(\"picture\", {\n    parentName: \"span\"\n  }, \"\\n        \", mdx(\"source\", _extends({\n    parentName: \"picture\"\n  }, {\n    \"srcSet\": [\"/static/fdfbd599bc1a79717bd0c24529bb7ffb/8d3d1/Magento_Varnish_01.webp 256w\", \"/static/fdfbd599bc1a79717bd0c24529bb7ffb/354cf/Magento_Varnish_01.webp 512w\", \"/static/fdfbd599bc1a79717bd0c24529bb7ffb/4d4cd/Magento_Varnish_01.webp 972w\"],\n    \"sizes\": \"(max-width: 972px) 100vw, 972px\",\n    \"type\": \"image/webp\"\n  })), \"\\n        \", mdx(\"source\", _extends({\n    parentName: \"picture\"\n  }, {\n    \"srcSet\": [\"/static/fdfbd599bc1a79717bd0c24529bb7ffb/85b06/Magento_Varnish_01.png 256w\", \"/static/fdfbd599bc1a79717bd0c24529bb7ffb/bc282/Magento_Varnish_01.png 512w\", \"/static/fdfbd599bc1a79717bd0c24529bb7ffb/298a5/Magento_Varnish_01.png 972w\"],\n    \"sizes\": \"(max-width: 972px) 100vw, 972px\",\n    \"type\": \"image/png\"\n  })), \"\\n        \", mdx(\"img\", _extends({\n    parentName: \"picture\"\n  }, {\n    \"className\": \"gatsby-resp-image-image\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\",\n      \"boxShadow\": \"inset 0px 0px 0px 400px white\"\n    },\n    \"src\": \"/static/fdfbd599bc1a79717bd0c24529bb7ffb/298a5/Magento_Varnish_01.png\",\n    \"alt\": \"Magento 2 with Varnish 6\",\n    \"title\": \"\"\n  })), \"\\n      \"), \"\\n  \")), mdx(\"ol\", {\n    \"start\": 6\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Click Save Config.\")), mdx(\"h2\", {\n    \"id\": \"export-a-varnish-configuration-file\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"href\": \"#export-a-varnish-configuration-file\",\n    \"aria-label\": \"export a varnish configuration file permalink\",\n    \"className\": \"anchor before\"\n  }), mdx(\"svg\", _extends({\n    parentName: \"a\"\n  }, {\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }), mdx(\"path\", _extends({\n    parentName: \"svg\"\n  }, {\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  })))), \"Export a Varnish Configuration File\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Click one of the export button to create a \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"varnish.vcl\"), \" you can use with Varnish.\")), mdx(\"p\", null, mdx(\"span\", _extends({\n    parentName: \"p\"\n  }, {\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"1024px\"\n    }\n  }), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"16.245136186770427%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  })), \"\\n    \", mdx(\"picture\", {\n    parentName: \"span\"\n  }, \"\\n        \", mdx(\"source\", _extends({\n    parentName: \"picture\"\n  }, {\n    \"srcSet\": [\"/static/fa3ab791212b3794e41a8dfeafc1a3b5/8d3d1/Magento_Varnish_02.webp 256w\", \"/static/fa3ab791212b3794e41a8dfeafc1a3b5/354cf/Magento_Varnish_02.webp 512w\", \"/static/fa3ab791212b3794e41a8dfeafc1a3b5/44907/Magento_Varnish_02.webp 1024w\", \"/static/fa3ab791212b3794e41a8dfeafc1a3b5/6fe5a/Magento_Varnish_02.webp 1028w\"],\n    \"sizes\": \"(max-width: 1024px) 100vw, 1024px\",\n    \"type\": \"image/webp\"\n  })), \"\\n        \", mdx(\"source\", _extends({\n    parentName: \"picture\"\n  }, {\n    \"srcSet\": [\"/static/fa3ab791212b3794e41a8dfeafc1a3b5/85b06/Magento_Varnish_02.png 256w\", \"/static/fa3ab791212b3794e41a8dfeafc1a3b5/bc282/Magento_Varnish_02.png 512w\", \"/static/fa3ab791212b3794e41a8dfeafc1a3b5/f1720/Magento_Varnish_02.png 1024w\", \"/static/fa3ab791212b3794e41a8dfeafc1a3b5/badb6/Magento_Varnish_02.png 1028w\"],\n    \"sizes\": \"(max-width: 1024px) 100vw, 1024px\",\n    \"type\": \"image/png\"\n  })), \"\\n        \", mdx(\"img\", _extends({\n    parentName: \"picture\"\n  }, {\n    \"className\": \"gatsby-resp-image-image\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\",\n      \"boxShadow\": \"inset 0px 0px 0px 400px white\"\n    },\n    \"src\": \"/static/fa3ab791212b3794e41a8dfeafc1a3b5/f1720/Magento_Varnish_02.png\",\n    \"alt\": \"Magento 2 with Varnish 6\",\n    \"title\": \"\"\n  })), \"\\n      \"), \"\\n  \")), mdx(\"ol\", {\n    \"start\": 2\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Upload the file to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/etc/varnish/varnish.vcl\"))), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"It is recommended to change the value of \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"acl purge\"), \" to the IP address of the Varnish host.\"))), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-bash\"\n  }), \" acl purge {\\n    \\\"localhost\\\";\\n }\\n\")), mdx(\"ol\", {\n    \"start\": 4\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Edit \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"nano /etc/default/varnish\"), \" to add the new configuration file:\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js\"\n  }), \"DAEMON_OPTS=\\\"-a :80 \\\\\\n             -T localhost:6082 \\\\\\n             -f /etc/varnish/varnish.vcl \\\\\\n             -S /etc/varnish/secret \\\\\\n             -s malloc,256m\\\"\\n\")), mdx(\"ol\", {\n    \"start\": 5\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Static files should not be cached by default, but if you want to cache them, you can edit the section \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Static files caching\"), \" in the VCL to have the following content:\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-bash\"\n  }), \"# Static files should not be cached by default\\n  return (pass);\\n\\n# But if you use a few locales and don't use CDN you can enable caching static files by commenting previous line (#return (pass);) and uncommenting next 3 lines\\n  #unset req.http.Https;\\n  #unset req.http./*  */;\\n  #unset req.http.Cookie;\\n\")), mdx(\"ol\", {\n    \"start\": 6\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"And reload Varnish and NGINX:\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-bash\"\n  }), \"systemctl daemon-reload\\nservice varnish restart\\nservice nginx restart\\n\")), mdx(\"ol\", {\n    \"start\": 7\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Now that you\\u2019re using the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"default.vcl\"), \" generated for you by Magento, you can perform some final verifications to make sure Varnish is working.\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-bash\"\n  }), \"curl -I -v --location-trusted 'http://my.domain.com'\\n\")));\n}\n;\nMDXContent.isMDXComponent = true;","excerpt":"Install Varnish 6 on Debian 10 Configure NGINX Modify the Varnish system configuration Modify default.vcl Configure Magento to use Varnish…","frontmatter":{"title":"Magento 2 and Varnish 6","date":"09/13/2019","categories":["LINUX","Magento"]},"timeToRead":2,"parent":{"__typename":"File","id":"a93ee02b-1922-518e-8512-9e7efbdda127","mtime":"2020-02-07T14:37:17.845Z","birthtime":"2020-01-13T08:26:45.575Z"}}},"pageContext":{"slug":"/magento-2-and-varnish-6","prev":{"fields":{"slug":"/magento-2-and-elasticsearch"},"frontmatter":{"title":"Magento 2 and Elasticsearch","categories":["LINUX","Elasticsearch","Magento"]}},"next":{"fields":{"slug":"/magento-2-manual-theme-installation"},"frontmatter":{"title":"Magento 2 Manual Theme Installation","categories":["LINUX","Magento"]}}}}}